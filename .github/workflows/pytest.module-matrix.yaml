---
## File: pytest.module-matrix.yaml

name: PyTest - Package Module Matrix
run-name: ${{ github.actor }} -> Package Module Matrix

on:

  workflow_call:

    inputs:

      pytests_location:
        required: true
        type: string
        default: false

      package_location:
        required: true
        type: string
        default: false

      github_action:
        required: false
        type: string
        default: ".github/actions/test-summary"

      artifacts_location:
        required: false
        type: string
        default: "artifacts"

    outputs:
      aggregated_results:
        description: "Providing PyTest Results Aggregation status"
        value: ${{ jobs.workflow-completed.outputs.aggregated_results }}

# push:
#   branches:
#     - master
#
# pull_request:
#   branches:
#     - master

jobs:

  validate-parameters:
    runs-on: ubuntu-latest
    steps:

      - name: Validate Input Parameters
        id: validate_parameters
        run: |

          if [[ -z "${{ inputs.pytests_location }}" ]]; then
            echo -e  "Error: '${{ env.GITHUB_WORKFLOW }}' cannot proceed without a valid PyTest Location." ;
            exit 1 ;
          fi ;

          if [[ -z "${{ inputs.package_location }}" ]]; then
            echo -e  "Error: '${{ env.GITHUB_WORKFLOW }}' cannot proceed without a valid Package Location." ;
            exit 1 ;
          fi ;

          if [[ -z "${{ inputs.github_action }}" ]]; then
            echo -e  "Error: '${{ env.GITHUB_WORKFLOW }}' cannot proceed without a valid GitHub Action." ;
            exit 1 ;
          fi ;

          if [[ -z "${{ inputs.artifacts_location }}" ]]; then
            echo -e  "Error: '${{ env.GITHUB_WORKFLOW }}' cannot proceed without a valid Artifacts Location." ;
            exit 1 ;
          fi ;

  packages-location:
    needs: validate-parameters
    runs-on: ubuntu-latest
    steps:

      - name: Check Packages Modules
        id: packages_location
        run: |
          if [[ -z "${{ inputs.package_location }}" ]]; then
            echo -en "Error: inputs.package_location must be provided. " ;
            echo -e  "The workflow cannot proceed without a valid target." ;
            exit 1 ;
          fi ;

  extracting-pytests:
    needs: [pytests-location, packages-location]
    uses: ./.github/workflows/module.extract-pytests.yaml
    with:
      github_action: "${{ inputs.github_action }}"

  running-pytests:
    needs: extracting-pytests
    uses: ./.github/workflows/module.running-pytests.yaml
    with:
      test_functions: ${{ needs.extracting-pytests.outputs.test_functions }}

  aggregating-pytests:
    needs: running-pytests
    uses: ./.github/workflows/module.aggregate-results.yaml
    with:
      github_action: "${{ inputs.github_action }}"
      artifacts_location: "${{ inputs.artifacts_location }}"

  workflow-completed:
    needs: aggregating-pytests
    runs-on: ubuntu-latest
    outputs:
      aggregated_results: ${{ needs.aggregating-pytests.outputs.aggregated_results }}
    steps:

      - name: Listing Entire Project
        id: listing_project
        run: |
          tree -FCla --prune -I .git ${{ github.workspace }} ;

      - name: Workflow Completion
        id: workflow_status
        run: |
          echo "Dependencies Matrix - GitHub Environment:\n${GITHUB_ENV}" ;
