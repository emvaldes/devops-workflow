---
## File: pytest.module-matrix.yaml

name: PyTest - Package Module Matrix
run-name: ${{ github.actor }} -> Package Module Matrix

on:

  workflow_call:

    inputs:

      pytests_location:
        required: true
        type: string
        default: ''

      package_location:
        required: true
        type: string
        default: ''

      github_action:
        required: false
        type: string
        default: ".github/actions/test-summary"

      artifacts_location:
        required: false
        type: string
        default: "artifacts"

    outputs:
      aggregated_results:
        description: "Providing PyTest Results Aggregation status"
        value: ${{ jobs.workflow-completed.outputs.aggregated_results }}

# push:
#   branches:
#     - master
#
# pull_request:
#   branches:
#     - master

jobs:

  validate-parameters:
    runs-on: ubuntu-latest
    steps:

      - name: Validate Input Parameters
        id: validate_parameters
        run: |

          invalid_params=false ;
          error_header="Workflow: 'pytest.module-matrix' cannot proceed without" ;

          [[ -z "${{ inputs.pytests_location }}" ]] && {
            echo -e "${error_header} a valid PyTest Location." ;
            invalid_params=true ;
          } ;
          [[ -z "${{ inputs.package_location }}" ]] && {
            echo -e "${error_header} a valid Package Location." ;
            invalid_params=true ;
          } ;
          [[ -z "${{ inputs.github_action }}" ]] && {
            echo -e "${error_header} a valid GitHub Action." ;
            invalid_params=true ;
          } ;
          [[ -z "${{ inputs.artifacts_location }}" ]] && {
            echo -e "${error_header} a valid Artifacts Location." ;
            invalid_params=true ;
          } ;

          [[ ${invalid_params} == true ]] && exit -1 ;

  extracting-pytests:
    needs: validate-parameters
    uses: ./.github/workflows/module.extract-pytests.yaml
    with:
      github_action: "${{ inputs.github_action }}"

  running-pytests:
    needs: extracting-pytests
    uses: ./.github/workflows/module.running-pytests.yaml
    with:
      test_functions: ${{ needs.extracting-pytests.outputs.test_functions }}

  aggregating-pytests:
    needs: running-pytests
    uses: ./.github/workflows/module.aggregate-results.yaml
    with:
      github_action: "${{ inputs.github_action }}"
      artifacts_location: "${{ inputs.artifacts_location }}"

  workflow-completed:
    needs: aggregating-pytests
    runs-on: ubuntu-latest
    outputs:
      aggregated_results: ${{ needs.aggregating-pytests.outputs.aggregated_results }}
    steps:

      - name: Listing Entire Project
        id: listing_project
        run: |
          tree -FCla --prune -I .git ${{ github.workspace }} ;

      - name: Workflow Completion
        id: workflow_status
        run: |
          echo "Dependencies Matrix - GitHub Environment:\n${GITHUB_ENV}" ;
