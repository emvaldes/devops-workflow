---
## File: pytest.dependencies-matrix.yaml

name: Requirements - Dependencies Matrix
run-name: ${{ github.actor }} -> Dependencies Matrix

on:

  workflow_call:

    inputs:

      pytests_dir:
        required: true
        type: string
        default: false

      package_path:
        required: true
        type: string
        default: false

      github_action:
        required: false
        type: string
        default: ".github/actions/test-summary"

      artifacts_path:
        required: false
        type: string
        default: "artifacts"

    outputs:
      aggregated_results:
        description: "Providing PyTest Results Aggregation status"
        value: ${{ jobs.workflow_completed.outputs.aggregated_results }}

# push:
#   branches:
#     - master
#
# pull_request:
#   branches:
#     - master

env:
  github_workflows: ".github/workflows"

jobs:

  pytests-location:
    id: pytests_location
    runs-on: ubuntu-latest
    steps:

      - name: Check PyTest Modules
        id: validate_modules
        run: |
          if [[ -z "${{ inputs.pytests_dir }}" ]]; then
            echo -en "Error: inputs.pytests_dir must be provided. " ;
            echo -e  "The workflow cannot proceed without a valid target." ;
            exit 1 ;
          fi ;

  packages-location:
    id: packages_location
    runs-on: ubuntu-latest
    steps:

      - name: Check Packages Modules
        id: validate_packages
        run: |
          if [[ -z "${{ inputs.package_path }}" ]]; then
            echo -en "Error: inputs.package_path must be provided. " ;
            echo -e  "The workflow cannot proceed without a valid target." ;
            exit 1 ;
          fi ;

  extracting-pytests:
    id: extracting_pytests
    needs: [pytests_location, packages_location]
    uses: ./${{ env.github_workflows }}/module.extract-pytests.yaml
    with:
      github_action: "${{ inputs.github_action }}"

  running-pytests:
    id: running_pytests
    needs: extracting_pytests
    uses: ./${{ env.github_workflows }}/module.running-pytests.yaml
    with:
      test_functions: ${{ needs.extracting_pytests.outputs.test_functions }}

  aggregating-pytests:
    id: aggregating_pytests
    needs: running_pytests
    uses: ./${{ env.github_workflows }}/module.aggregate-results.yaml
    with:
      github_action: "${{ inputs.github_action }}"
      artifacts_path: "${{ inputs.artifacts_path }}"

  workflow-completed:
    id: workflow_completed
    needs: aggregating_pytests
    runs-on: ubuntu-latest
    outputs:
      aggregated_results: ${{ needs.aggregating_pytests.outputs.aggregated_results }}
    steps:

      - name: Workflow Completion
        id: workflow_status
        run: |
          echo "Dependencies Matrix - GitHub Environment:\n${GITHUB_ENV}" ;
