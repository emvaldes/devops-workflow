---
## File: module.aggregate-results.yaml

name: Aggregate PyTests Results
on:

  workflow_call:

    inputs:

      github_action:
        required: true
        type: string

      artifacts_location:
        required: true
        type: string
        default: "artifacts"

    outputs:

      aggregated_results:
        description: "Signaling PyTest Results Aggregation completion"
        value: ${{ jobs.aggregate-pytest-results.outputs.aggregated_results }}

jobs:

  validate-parameters:
    runs-on: ubuntu-latest
    steps:

      - name: Validate Input Parameters
        id: validate_parameters
        run: |

          params=false ;
          error_header="Workflow: 'module.aggregate-results' cannot proceed without" ;

          [[ "${{ inputs.github_action }}" == '' ]] && {
            echo -e "${error_header} a valid GitHub Action." ;
            invalid_params=true ;
          } ;
          [[ "${{ inputs.artifacts_location }}" == '' ]] && {
            echo -e "${error_header} a valid Artifacts Location." ;
            invalid_params=true ;
          } ;

          [[ ${invalid_params} == true ]] && exit -1 ;

  aggregate-pytest-results:
    needs: validate-parameters
    runs-on: ubuntu-latest
    outputs:
      aggregated_results: "true"
    steps:

      - name: Install System Packages
        id: installing_system_packages
        run: |
          sudo apt-get update --yes ;
          sudo apt-get install tree jq --yes ;

      - name: Checkout Repository
        id: checkout_repository
        uses: actions/checkout@v4

      - name: Ensure Script is Executable
        id: executable_script
        run: |
          chmod +x ${{ inputs.github_action }}/inspect-artifacts-state.shell ;

      - name: Locating Artifacts
        id: locating_artifacts
        run: |
          ${{ inputs.github_action }}/inspect-artifacts-state.shell ;

      - name: Download All Test Artifacts
        id: downloading_artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ inputs.artifacts_location }}/

      - name: Verify Downloaded Artifacts
        id: verifying_artifacts
        run: |
          echo -e "Listing downloaded artifacts..." ;
          tree -FCla --prune -I .git ./artifacts 2>/dev/null ;

      - name: Aggregate Pytest Results
        id: aggregating_results
        run: |
          ${{ inputs.github_action }}/aggregate-pytest-results.shell ;

      - name: Configure Workflow Status
        id: workflow_status
        run: |
          echo "aggregated_results=true" >> $GITHUB_ENV
          echo "Aggregate Results - GitHub Environment:\n${GITHUB_ENV}" ;
